# Rootly Edge Connector Actions - Development/Testing
# Simplified format for local development and Docker testing

defaults:
  timeout: 30
  source_type: local

# Automatic actions for testing
on:
  alert.created:
    script: /opt/rootly-edge-connector/scripts/test-echo.sh
    parameters:
      alert_id: "{{ id }}"
      summary: "{{ summary }}"
      severity: "{{ labels.severity }}"
      host: "{{ data.host }}"
      service: "{{ services[0].name }}"

  incident.created:
    http:
      url: "https://httpbin.org/post"
      method: POST
      headers:
        Content-Type: application/json
      body: |
        {
          "incident_id": "{{ id }}",
          "title": "{{ title }}",
          "severity": "{{ severity.name }}"
        }

# Callable actions for testing
callable:
  # Standalone action
  test_standalone_action:
    name: Test Standalone Action
    description: Test standalone callable action
    script: /opt/rootly-edge-connector/scripts/test-echo.sh
    # trigger defaults to: action.triggered
    parameter_definitions:
      - name: message
        type: string
        required: false
        default: Hello
    # Auto-generated: message: "{{ parameters.message }}"
    # Only specify extras:
    parameters:
      triggered_by_name: "{{ triggered_by.name }}"
      triggered_by_email: "{{ triggered_by.email }}"

  # Alert-specific action
  test_alert_action:
    name: Test Alert Action
    description: Test action triggered from alert
    trigger: alert.action_triggered
    script: /opt/rootly-edge-connector/scripts/test-echo.sh
    parameter_definitions:
      - name: service_name
        type: string
        required: true
        description: Service to restart
    # Auto-generated: service_name: "{{ parameters.service_name }}"
    # Extras:
    parameters:
      entity_id: "{{ entity_id }}"
      triggered_by: "{{ triggered_by.email }}"

  # Incident-specific action
  test_incident_action:
    name: Test Incident Action
    description: Test action triggered from incident
    trigger: incident.action_triggered
    http:
      url: "https://httpbin.org/post"
      method: POST
      headers:
        Content-Type: application/json
      body: |
        {
          "message": "{{ parameters.message }}",
          "incident_id": "{{ entity_id }}",
          "triggered_by": "{{ triggered_by.email }}"
        }
    parameter_definitions:
      - name: message
        type: string
        required: true
        description: Message to send

  # Multi-entity action with list parameters
  restart_test_service:
    name: Restart Test Service
    description: Restart service (works on alerts, incidents, and standalone)
    trigger: alert.action_triggered
    script: /opt/rootly-edge-connector/scripts/test-echo.sh
    parameter_definitions:
      - name: service_name
        type: string
        required: true
        description: Service name to restart
      - name: environment
        type: list
        required: false
        default: development
        options: [development, staging, production]
        description: Target environment
    # Auto-generated: service_name, environment
    # Only specify extras:
    parameters:
      entity_id: "{{ entity_id | default: 'none' }}"
      triggered_by: "{{ triggered_by.email }}"
      log_level: debug
      region: us-west-2
    timeout: 60

  # Git-based action (ready to test!)
  test_git_echo:
    name: Test Git-Based Echo
    description: Execute script from Git repository
    source_type: git
    script: scripts/test-echo.sh
    git_options:
      url: "https://github.com/rootlyhq/rootly-edge-connector.git"
      branch: master
      poll_interval_sec: 60
    parameter_definitions:
      - name: test_param
        type: string
        default: test_value
    # Auto-generated: test_param: "{{ parameters.test_param }}"
    # Extras (additional context not from UI):
    parameters:
      alert_id: "{{ id }}"
      summary: "{{ summary }}"

# Testing notes:
# - Script paths use Docker paths (/opt/rootly-edge-connector/scripts/*)
# - For local testing outside Docker, update paths to absolute local paths
# - Git-based action (test_git_echo) works everywhere without path changes
# - HTTP actions use httpbin.org (no auth required, safe for testing)
# - All callable actions have parameter_definitions (required for UI)
# - Automatic actions (on:) have no parameter_definitions
